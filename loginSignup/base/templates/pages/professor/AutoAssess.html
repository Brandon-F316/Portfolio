{% extends "pages/main.html" %}
{% load widget_tweaks %}
{% block content %}

<div class="container mt-5">
    <!-- Heading -->
    <h1 class="display-4 text-center mb-4">Assessment</h1>

    <!-- Form for file upload -->
    <form id="uploadForm" method="POST" enctype="multipart/form-data" class="mb-5">
        <h3>Extract PIs from file</h3>
        {% csrf_token %}
        <div class="form-group">
            <label for="file">Upload Syllabus File</label>
            {{ form.file }}
        </div>
        <button type="submit" class="btn btn-primary">Extract</button>
    </form>

    <!-- Display extracted performance indicators -->
    {% if extracted_performance_indicators %}
        <h2 class="mt-5">Extracted Performance Indicators</h2>
        <ul class="list-group">
            {% for pi in extracted_performance_indicators %}
                <li class="list-group-item">{{ pi }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <!-- Uploaded files section -->
    <h2 class="mt-5">Your Uploaded Files</h2>
    <ul id="file-list" class="list-group">
        {% for file in uploaded_files %}
            <li id="file-{{ file.id }}" class="list-group-item">
                <strong>{{ file.file.name }}</strong> <br>
                <a href="{{ file.file.url }}" target="_blank" class="btn btn-link">View File</a>
                <button onclick="deleteFile('{{ file.id }}')" class="btn btn-danger btn-sm ml-3">Delete</button>

                <h3 class="mt-3">Extracted Performance Indicators</h3>
                <ul class="list-group">
                    {% for pi in file.PIs %}
                        {% if pi %}
                            <li class="list-group-item">{{ pi }}</li>
                        {% endif %}
                    {% endfor %}
                </ul>
            </li>
        {% empty %}
            <li class="list-group-item">You haven't uploaded any files yet.</li>
        {% endfor %}
    </ul>

    <!-- Navigation buttons -->
    <div class="mt-4">
        <a href="{% url 'base:edit' %}" class="btn btn-warning mr-2">Edit PIs</a>
        <a href="{% url 'base:setup' %}" class="btn btn-success">Next Step</a>
    </div>
</div>

<script>
    function deleteFile(fileId) {
        const csrfToken = '{{ csrf_token }}';
        
        fetch(`/delete_file/${fileId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert("Failed to delete the file.");
            }
        })
        .catch(error => console.error('Error:', error));
    }
</script>

{% endblock content %}
